<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>å‰æ–¹ä½ã‚³ãƒ³ãƒ‘ã‚¹ | ä¹æ˜Ÿæ°—å­¦</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Zen+Kaku+Gothic+New:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-card: #1a1a24;
      --text-primary: #f0f0f5;
      --text-secondary: #8888a0;
      --text-muted: #55556a;
      --accent-gold: #d4a574;
      --accent-gold-dim: rgba(212, 165, 116, 0.3);
      --lucky-green: #4ade80;
      --lucky-green-dim: rgba(74, 222, 128, 0.15);
      --warning-red: #f87171;
      --warning-red-dim: rgba(248, 113, 113, 0.15);
      --neutral-gray: #6b7280;
      --ring-outer: rgba(212, 165, 116, 0.08);
      --ring-inner: rgba(212, 165, 116, 0.12);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: 'Zen Kaku Gothic New', 'Noto Sans JP', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      -webkit-font-smoothing: antialiased;
    }

    /* Setup Screen */
    .setup-screen {
      position: fixed;
      inset: 0;
      background: var(--bg-primary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      z-index: 100;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .setup-screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .setup-logo {
      width: 80px;
      height: 80px;
      border: 2px solid var(--accent-gold);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 2rem;
      position: relative;
    }

    .setup-logo::before {
      content: 'â˜¯';
      font-size: 2.5rem;
      color: var(--accent-gold);
    }

    .setup-title {
      font-size: 1.5rem;
      font-weight: 500;
      letter-spacing: 0.2em;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }

    .setup-subtitle {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 3rem;
      letter-spacing: 0.1em;
    }

    .setup-form {
      width: 100%;
      max-width: 320px;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      letter-spacing: 0.05em;
    }

    .form-input {
      width: 100%;
      padding: 1rem;
      background: var(--bg-card);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.2s ease;
    }

    .form-input:focus {
      border-color: var(--accent-gold);
    }

    .start-button {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, var(--accent-gold), #c49a6c);
      border: none;
      border-radius: 12px;
      color: var(--bg-primary);
      font-family: inherit;
      font-size: 1rem;
      font-weight: 500;
      letter-spacing: 0.1em;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      margin-top: 1rem;
    }

    .start-button:active {
      transform: scale(0.98);
    }

    .start-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Main App */
    .app-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem;
      padding-top: env(safe-area-inset-top, 1rem);
      padding-bottom: env(safe-area-inset-bottom, 1rem);
      overflow: hidden;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      margin-bottom: 0.5rem;
    }

    .date-display {
      font-size: 0.75rem;
      color: var(--text-secondary);
      letter-spacing: 0.05em;
    }

    .star-badge {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--bg-card);
      border-radius: 20px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .star-badge:hover {
      background: var(--bg-secondary);
    }

    .star-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
    }

    .star-name {
      font-size: 0.875rem;
      font-weight: 500;
    }

    /* Compass Section */
    .compass-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      min-height: 0;
    }

    .compass-container {
      position: relative;
      width: min(85vw, 380px);
      height: min(85vw, 380px);
      flex-shrink: 0;
    }

    .compass-ring {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      border: 1px solid var(--ring-outer);
      background: radial-gradient(circle at center, var(--bg-secondary) 0%, var(--bg-primary) 100%);
    }

    .compass-ring::before {
      content: '';
      position: absolute;
      inset: 15%;
      border-radius: 50%;
      border: 1px solid var(--ring-inner);
    }

    .compass-ring::after {
      content: '';
      position: absolute;
      inset: 35%;
      border-radius: 50%;
      border: 1px solid var(--ring-inner);
    }

    .compass-dial {
      position: absolute;
      inset: 0;
      transition: transform 0.1s ease-out;
    }

    .direction-marker {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      transform: translate(-50%, -50%);
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .direction-marker:hover {
      transform: translate(-50%, -50%) scale(1.1);
    }

    .direction-marker.lucky .direction-circle {
      background: var(--lucky-green-dim);
      border-color: var(--lucky-green);
      box-shadow: 0 0 20px rgba(74, 222, 128, 0.3);
    }

    .direction-marker.lucky .direction-label {
      color: var(--lucky-green);
    }

    .direction-marker.unlucky .direction-circle {
      background: var(--warning-red-dim);
      border-color: var(--warning-red);
    }

    .direction-marker.unlucky .direction-label {
      color: var(--warning-red);
    }

    .direction-circle {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 2px solid var(--text-muted);
      background: rgba(255,255,255,0.03);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .direction-kanji {
      font-size: 1rem;
      font-weight: 500;
    }

    .direction-label {
      font-size: 0.625rem;
      color: var(--text-muted);
      margin-top: 4px;
      letter-spacing: 0.05em;
      transition: color 0.3s ease;
    }

    /* Center */
    .compass-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 2px solid var(--accent-gold-dim);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .center-star {
      font-size: 0.625rem;
      color: var(--text-secondary);
      margin-bottom: 2px;
    }

    .center-label {
      font-size: 0.75rem;
      color: var(--accent-gold);
      font-weight: 500;
    }

    /* Heading Indicator */
    .heading-indicator {
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 20;
    }

    .heading-arrow {
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 14px solid var(--accent-gold);
      filter: drop-shadow(0 0 6px var(--accent-gold));
    }

    /* Info Panel */
    .info-panel {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-card);
      border-radius: 16px;
      width: 100%;
      max-width: 380px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
    }

    .info-row:not(:last-child) {
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .info-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .info-value {
      font-size: 0.875rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .heading-value {
      font-family: 'SF Mono', 'Monaco', monospace;
      font-size: 1rem;
      color: var(--accent-gold);
    }

    .lucky-directions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .lucky-tag {
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .lucky-tag.good {
      background: var(--lucky-green-dim);
      color: var(--lucky-green);
    }

    .lucky-tag.bad {
      background: var(--warning-red-dim);
      color: var(--warning-red);
    }

    /* Permission overlay */
    .permission-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      z-index: 200;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .permission-overlay.visible {
      opacity: 1;
      visibility: visible;
    }

    .permission-icon {
      font-size: 3rem;
      margin-bottom: 1.5rem;
    }

    .permission-text {
      text-align: center;
      margin-bottom: 2rem;
      color: var(--text-secondary);
      line-height: 1.8;
    }

    .permission-button {
      padding: 1rem 2rem;
      background: var(--accent-gold);
      border: none;
      border-radius: 12px;
      color: var(--bg-primary);
      font-family: inherit;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
    }

    /* Direction detail modal */
    .detail-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      z-index: 150;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .detail-modal.visible {
      opacity: 1;
      visibility: visible;
    }

    .detail-content {
      background: var(--bg-card);
      border-radius: 24px 24px 0 0;
      padding: 2rem;
      width: 100%;
      max-width: 420px;
      max-height: 60vh;
      overflow-y: auto;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }

    .detail-modal.visible .detail-content {
      transform: translateY(0);
    }

    .detail-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .detail-direction-circle {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: 2px solid var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 500;
    }

    .detail-direction-circle.lucky {
      background: var(--lucky-green-dim);
      border-color: var(--lucky-green);
    }

    .detail-direction-circle.unlucky {
      background: var(--warning-red-dim);
      border-color: var(--warning-red);
    }

    .detail-title {
      flex: 1;
    }

    .detail-title h3 {
      font-size: 1.25rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
    }

    .detail-title p {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .detail-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--bg-secondary);
      border: none;
      color: var(--text-secondary);
      font-size: 1.25rem;
      cursor: pointer;
    }

    .detail-info {
      padding: 1rem;
      background: var(--bg-secondary);
      border-radius: 12px;
      margin-bottom: 1rem;
    }

    .detail-info-row {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
    }

    .detail-info-row:not(:last-child) {
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .detail-info-label {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .detail-info-value {
      font-weight: 500;
    }

    .detail-description {
      color: var(--text-secondary);
      font-size: 0.875rem;
      line-height: 1.8;
    }

    /* Star colors */
    .star-1 { background: #3b82f6; color: white; }
    .star-2 { background: #713f12; color: white; }
    .star-3 { background: #16a34a; color: white; }
    .star-4 { background: #22c55e; color: white; }
    .star-5 { background: #eab308; color: black; }
    .star-6 { background: #f5f5f5; color: black; }
    .star-7 { background: #f87171; color: white; }
    .star-8 { background: #e5e5e5; color: black; }
    .star-9 { background: #a855f7; color: white; }

    /* Animations */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .loading {
      animation: pulse 1.5s infinite;
    }

    /* Responsive */
    @media (max-height: 700px) {
      .compass-container {
        width: min(70vw, 300px);
        height: min(70vw, 300px);
      }
      
      .direction-circle {
        width: 36px;
        height: 36px;
      }
      
      .direction-kanji {
        font-size: 0.875rem;
      }
      
      .compass-center {
        width: 56px;
        height: 56px;
      }
    }
  </style>
</head>
<body>
  <!-- Setup Screen -->
  <div class="setup-screen" id="setupScreen">
    <div class="setup-logo"></div>
    <h1 class="setup-title">å‰æ–¹ä½ã‚³ãƒ³ãƒ‘ã‚¹</h1>
    <p class="setup-subtitle">ä¹æ˜Ÿæ°—å­¦</p>
    
    <form class="setup-form" id="setupForm">
      <div class="form-group">
        <label class="form-label">ç”Ÿå¹´æœˆæ—¥</label>
        <input type="date" class="form-input" id="birthdate" required>
      </div>
      <button type="submit" class="start-button" id="startButton">
        ã‚³ãƒ³ãƒ‘ã‚¹ã‚’é–‹å§‹
      </button>
    </form>
  </div>

  <!-- Permission Overlay -->
  <div class="permission-overlay" id="permissionOverlay">
    <div class="permission-icon">ğŸ§­</div>
    <p class="permission-text">
      ã‚³ãƒ³ãƒ‘ã‚¹æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯<br>
      ãƒ‡ãƒã‚¤ã‚¹ã®å‘ãã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’<br>
      è¨±å¯ã—ã¦ãã ã•ã„
    </p>
    <button class="permission-button" id="permissionButton">
      è¨±å¯ã™ã‚‹
    </button>
  </div>

  <!-- Main App -->
  <div class="app-container">
    <header class="header">
      <div class="date-display" id="dateDisplay">--å¹´--æœˆ--æ—¥</div>
      <div class="star-badge" id="starBadge">
        <div class="star-icon" id="starIcon">-</div>
        <span class="star-name" id="starName">---</span>
      </div>
    </header>

    <section class="compass-section">
      <div class="compass-container">
        <div class="heading-indicator">
          <div class="heading-arrow"></div>
        </div>
        
        <div class="compass-ring"></div>
        
        <div class="compass-dial" id="compassDial">
          <!-- Direction markers will be inserted here -->
        </div>
        
        <div class="compass-center">
          <span class="center-star" id="centerStar">ä¸­å®®</span>
          <span class="center-label" id="centerLabel">-</span>
        </div>
      </div>
      
      <div class="info-panel">
        <div class="info-row">
          <span class="info-label">ç¾åœ¨ã®å‘ã</span>
          <span class="info-value">
            <span class="heading-value" id="headingValue">---Â°</span>
            <span id="headingDirection">--</span>
          </span>
        </div>
        <div class="info-row">
          <span class="info-label">ä»Šæ—¥ã®å‰æ–¹ä½</span>
          <div class="lucky-directions" id="luckyDirections">
            <!-- Lucky direction tags -->
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Direction Detail Modal -->
  <div class="detail-modal" id="detailModal">
    <div class="detail-content">
      <div class="detail-header">
        <div class="detail-direction-circle" id="detailCircle">-</div>
        <div class="detail-title">
          <h3 id="detailName">--</h3>
          <p id="detailAngle">--</p>
        </div>
        <button class="detail-close" id="detailClose">Ã—</button>
      </div>
      <div class="detail-info">
        <div class="detail-info-row">
          <span class="detail-info-label">æ–¹ä½ã®ä¹æ˜Ÿ</span>
          <span class="detail-info-value" id="detailStar">--</span>
        </div>
        <div class="detail-info-row">
          <span class="detail-info-label">å‰å‡¶</span>
          <span class="detail-info-value" id="detailLuck">--</span>
        </div>
      </div>
      <p class="detail-description" id="detailDescription"></p>
    </div>
  </div>

  <script>
    // ===== Constants =====
    const STAR_NAMES = [
      '', 'ä¸€ç™½æ°´æ˜Ÿ', 'äºŒé»’åœŸæ˜Ÿ', 'ä¸‰ç¢§æœ¨æ˜Ÿ', 'å››ç·‘æœ¨æ˜Ÿ', 
      'äº”é»„åœŸæ˜Ÿ', 'å…­ç™½é‡‘æ˜Ÿ', 'ä¸ƒèµ¤é‡‘æ˜Ÿ', 'å…«ç™½åœŸæ˜Ÿ', 'ä¹ç´«ç«æ˜Ÿ'
    ];
    
    const STAR_SHORT = ['', 'ä¸€ç™½', 'äºŒé»’', 'ä¸‰ç¢§', 'å››ç·‘', 'äº”é»„', 'å…­ç™½', 'ä¸ƒèµ¤', 'å…«ç™½', 'ä¹ç´«'];
    
    const STAR_ELEMENTS = {
      1: 'æ°´', 2: 'åœŸ', 3: 'æœ¨', 4: 'æœ¨', 5: 'åœŸ', 6: 'é‡‘', 7: 'é‡‘', 8: 'åœŸ', 9: 'ç«'
    };
    
    // å¾Œå¤©å®šä½ç›¤ã®é…ç½®ï¼ˆä¸­å®®ãŒ5ã®å ´åˆï¼‰
    // æ–¹ä½: [åŒ—, åŒ—æ±, æ±, å—æ±, å—, å—è¥¿, è¥¿, åŒ—è¥¿]
    const BASE_POSITIONS = {
      north: 1, northeast: 8, east: 3, southeast: 4,
      south: 9, southwest: 2, west: 7, northwest: 6
    };
    
    const DIRECTIONS = [
      { key: 'north', kanji: 'åŒ—', label: 'N', angle: 0, basePos: 1 },
      { key: 'northeast', kanji: 'åŒ—æ±', label: 'NE', angle: 45, basePos: 8 },
      { key: 'east', kanji: 'æ±', label: 'E', angle: 90, basePos: 3 },
      { key: 'southeast', kanji: 'å—æ±', label: 'SE', angle: 135, basePos: 4 },
      { key: 'south', kanji: 'å—', label: 'S', angle: 180, basePos: 9 },
      { key: 'southwest', kanji: 'å—è¥¿', label: 'SW', angle: 225, basePos: 2 },
      { key: 'west', kanji: 'è¥¿', label: 'W', angle: 270, basePos: 7 },
      { key: 'northwest', kanji: 'åŒ—è¥¿', label: 'NW', angle: 315, basePos: 6 }
    ];

    // äº”è¡Œã®ç›¸ç”Ÿãƒ»ç›¸å‰‹
    const ELEMENT_RELATIONS = {
      'æ°´': { generates: 'æœ¨', generated_by: 'é‡‘', controls: 'ç«', controlled_by: 'åœŸ' },
      'æœ¨': { generates: 'ç«', generated_by: 'æ°´', controls: 'åœŸ', controlled_by: 'é‡‘' },
      'ç«': { generates: 'åœŸ', generated_by: 'æœ¨', controls: 'é‡‘', controlled_by: 'æ°´' },
      'åœŸ': { generates: 'é‡‘', generated_by: 'ç«', controls: 'æ°´', controlled_by: 'æœ¨' },
      'é‡‘': { generates: 'æ°´', generated_by: 'åœŸ', controls: 'æœ¨', controlled_by: 'ç«' }
    };

    // ===== State =====
    let state = {
      birthdate: null,
      honmeisei: null,  // æœ¬å‘½æ˜Ÿ
      dailyStar: null,  // æ—¥ç›¤ã®ä¸­å®®æ˜Ÿ
      currentHeading: 0,
      directionStatus: {},
      isCompassActive: false
    };

    // ===== DOM Elements =====
    const elements = {
      setupScreen: document.getElementById('setupScreen'),
      setupForm: document.getElementById('setupForm'),
      birthdate: document.getElementById('birthdate'),
      permissionOverlay: document.getElementById('permissionOverlay'),
      permissionButton: document.getElementById('permissionButton'),
      dateDisplay: document.getElementById('dateDisplay'),
      starBadge: document.getElementById('starBadge'),
      starIcon: document.getElementById('starIcon'),
      starName: document.getElementById('starName'),
      compassDial: document.getElementById('compassDial'),
      centerStar: document.getElementById('centerStar'),
      centerLabel: document.getElementById('centerLabel'),
      headingValue: document.getElementById('headingValue'),
      headingDirection: document.getElementById('headingDirection'),
      luckyDirections: document.getElementById('luckyDirections'),
      detailModal: document.getElementById('detailModal'),
      detailCircle: document.getElementById('detailCircle'),
      detailName: document.getElementById('detailName'),
      detailAngle: document.getElementById('detailAngle'),
      detailStar: document.getElementById('detailStar'),
      detailLuck: document.getElementById('detailLuck'),
      detailDescription: document.getElementById('detailDescription'),
      detailClose: document.getElementById('detailClose')
    };

    // ===== Calculation Functions =====
    
    // ç«‹æ˜¥åˆ¤å®šã®ãŸã‚ã®ç¯€å…¥ã‚Šæ—¥ï¼ˆç°¡æ˜“ç‰ˆï¼š2æœˆ4æ—¥ã‚’åŸºæº–ï¼‰
    function getLunarYear(date) {
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      
      // 2æœˆ4æ—¥ã‚ˆã‚Šå‰ãªã‚‰å‰å¹´æ‰±ã„
      if (month < 2 || (month === 2 && day < 4)) {
        return year - 1;
      }
      return year;
    }

    // æœ¬å‘½æ˜Ÿã‚’è¨ˆç®—ï¼ˆè¥¿æš¦ã‹ã‚‰ï¼‰
    function calculateHonmeisei(birthdate) {
      const lunarYear = getLunarYear(birthdate);
      
      // å„æ¡ã‚’è¶³ã™
      let sum = String(lunarYear).split('').reduce((a, b) => a + parseInt(b), 0);
      
      // 1æ¡ã«ãªã‚‹ã¾ã§è¶³ã™
      while (sum >= 10) {
        sum = String(sum).split('').reduce((a, b) => a + parseInt(b), 0);
      }
      
      // 11ã‹ã‚‰å¼•ã
      let star = 11 - sum;
      if (star > 9) star = star - 9;
      if (star <= 0) star = star + 9;
      
      return star;
    }

    // æ—¥ç›¤ã®ä¸­å®®æ˜Ÿã‚’è¨ˆç®—
    function calculateDailyStar(date) {
      // åŸºæº–æ—¥: 1936å¹´1æœˆ1æ—¥ ã¯ ä¸€ç™½æ°´æ˜Ÿã®æ—¥
      // 9æ—¥å‘¨æœŸã§é€†é †ã«å›ã‚‹ï¼ˆé™½éãƒ»éš éã‚’ç°¡ç•¥åŒ–ï¼‰
      const baseDate = new Date(1936, 0, 1);
      const targetDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      
      const diffTime = targetDate - baseDate;
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      
      // å†¬è‡³ã‚’å¢ƒã«é™½éãƒ»é™°éãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹ãŒã€ç°¡æ˜“ç‰ˆã§ã¯é™°éï¼ˆé€†é †ï¼‰ã§è¨ˆç®—
      // ã‚ˆã‚Šæ­£ç¢ºã«ã™ã‚‹ã«ã¯ä¸‡å¹´æš¦ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦
      let star = 1 - (diffDays % 9);
      if (star <= 0) star += 9;
      
      return star;
    }

    // æ–¹ä½ç›¤ã®æ˜Ÿé…ç½®ã‚’è¨ˆç®—ï¼ˆä¸­å®®æ˜Ÿã‹ã‚‰ï¼‰
    function calculateDirectionStars(centerStar) {
      const positions = {};
      const offset = 5 - centerStar; // 5ï¼ˆäº”é»„ï¼‰ã‹ã‚‰ã®ãšã‚Œ
      
      DIRECTIONS.forEach(dir => {
        let star = dir.basePos + offset;
        if (star > 9) star -= 9;
        if (star <= 0) star += 9;
        positions[dir.key] = star;
      });
      
      return positions;
    }

    // å‰å‡¶åˆ¤å®š
    function calculateLuckStatus(honmeisei, directionStars, dailyStar) {
      const status = {};
      const honmeiElement = STAR_ELEMENTS[honmeisei];
      
      Object.entries(directionStars).forEach(([direction, star]) => {
        const dirElement = STAR_ELEMENTS[star];
        let luck = 'neutral';
        let reason = '';
        
        // äº”é»„æ®ºï¼ˆãã®æ–¹ä½ã«äº”é»„åœŸæ˜ŸãŒã‚ã‚‹ï¼‰
        if (star === 5) {
          luck = 'bad';
          reason = 'äº”é»„æ®ºï¼šæœ€ã‚‚å¼·ã„å‡¶æ–¹ä½';
        }
        // æš—å‰£æ®ºï¼ˆäº”é»„ã®åå¯¾æ–¹ä½ï¼‰
        else if (isOppositeTo5(direction, directionStars)) {
          luck = 'bad';
          reason = 'æš—å‰£æ®ºï¼šä»–è€…ã‹ã‚‰ã®ç½ã„ã‚’å—ã‘ã‚„ã™ã„';
        }
        // æœ¬å‘½æ®ºï¼ˆæœ¬å‘½æ˜ŸãŒã‚ã‚‹æ–¹ä½ï¼‰
        else if (star === honmeisei) {
          luck = 'bad';
          reason = 'æœ¬å‘½æ®ºï¼šå¥åº·é‹ã«æ‚ªå½±éŸ¿';
        }
        // æœ¬å‘½çš„æ®ºï¼ˆæœ¬å‘½æ˜Ÿã®åå¯¾æ–¹ä½ï¼‰
        else if (isOppositeToHonmei(direction, directionStars, honmeisei)) {
          luck = 'bad';
          reason = 'æœ¬å‘½çš„æ®ºï¼šç²¾ç¥çš„ãªãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã‚„ã™ã„';
        }
        // ç›¸ç”Ÿï¼ˆç”Ÿæ°—ãƒ»é€€æ°—ã§è‰¯ã„æ–¹ä½ï¼‰
        else if (ELEMENT_RELATIONS[honmeiElement]?.generated_by === dirElement ||
                 ELEMENT_RELATIONS[honmeiElement]?.generates === dirElement) {
          luck = 'good';
          reason = dirElement === ELEMENT_RELATIONS[honmeiElement]?.generated_by 
            ? 'ç”Ÿæ°—ï¼šã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’å—ã‘å–ã‚Œã‚‹å‰æ–¹ä½'
            : 'é€€æ°—ï¼šç©ã‚„ã‹ãªç™ºå±•ãŒæœŸå¾…ã§ãã‚‹æ–¹ä½';
        }
        // æ¯”å’Œï¼ˆåŒã˜äº”è¡Œï¼‰
        else if (honmeiElement === dirElement) {
          luck = 'good';
          reason = 'æ¯”å’Œï¼šåŒã˜æ°—ãŒåˆã‚ã•ã‚ŠåŠ›ãŒå¢—ã™';
        }
        
        status[direction] = { star, luck, reason };
      });
      
      return status;
    }

    function isOppositeTo5(direction, directionStars) {
      const opposites = {
        north: 'south', south: 'north',
        east: 'west', west: 'east',
        northeast: 'southwest', southwest: 'northeast',
        southeast: 'northwest', northwest: 'southeast'
      };
      return directionStars[opposites[direction]] === 5;
    }

    function isOppositeToHonmei(direction, directionStars, honmeisei) {
      const opposites = {
        north: 'south', south: 'north',
        east: 'west', west: 'east',
        northeast: 'southwest', southwest: 'northeast',
        southeast: 'northwest', northwest: 'southeast'
      };
      return directionStars[opposites[direction]] === honmeisei;
    }

    // ===== UI Functions =====
    
    function formatDate(date) {
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      const weekday = weekdays[date.getDay()];
      return `${year}å¹´${month}æœˆ${day}æ—¥ï¼ˆ${weekday}ï¼‰`;
    }

    function renderCompassDial() {
      elements.compassDial.innerHTML = '';
      const radius = 42; // percentage from center
      
      DIRECTIONS.forEach(dir => {
        const status = state.directionStatus[dir.key] || { star: 0, luck: 'neutral' };
        const angleRad = (dir.angle - 90) * Math.PI / 180;
        const x = 50 + radius * Math.cos(angleRad);
        const y = 50 + radius * Math.sin(angleRad);
        
        const marker = document.createElement('div');
        marker.className = `direction-marker ${status.luck === 'good' ? 'lucky' : ''} ${status.luck === 'bad' ? 'unlucky' : ''}`;
        marker.style.left = `${x}%`;
        marker.style.top = `${y}%`;
        marker.dataset.direction = dir.key;
        
        marker.innerHTML = `
          <div class="direction-circle">
            <span class="direction-kanji">${dir.kanji}</span>
          </div>
          <span class="direction-label">${STAR_SHORT[status.star] || ''}</span>
        `;
        
        marker.addEventListener('click', () => showDirectionDetail(dir));
        elements.compassDial.appendChild(marker);
      });
    }

    function updateUI() {
      const today = new Date();
      
      // Date display
      elements.dateDisplay.textContent = formatDate(today);
      
      // Star badge
      elements.starIcon.textContent = state.honmeisei;
      elements.starIcon.className = `star-icon star-${state.honmeisei}`;
      elements.starName.textContent = STAR_NAMES[state.honmeisei];
      
      // Center label
      elements.centerLabel.textContent = STAR_SHORT[state.dailyStar];
      
      // Lucky directions
      const luckyDirs = DIRECTIONS.filter(d => 
        state.directionStatus[d.key]?.luck === 'good'
      );
      const badDirs = DIRECTIONS.filter(d => 
        state.directionStatus[d.key]?.luck === 'bad'
      );
      
      elements.luckyDirections.innerHTML = '';
      
      if (luckyDirs.length === 0 && badDirs.length === 0) {
        elements.luckyDirections.innerHTML = '<span class="lucky-tag" style="background: var(--bg-secondary); color: var(--text-secondary);">åˆ¤å®šä¸­...</span>';
      } else {
        luckyDirs.forEach(d => {
          const tag = document.createElement('span');
          tag.className = 'lucky-tag good';
          tag.textContent = d.kanji;
          elements.luckyDirections.appendChild(tag);
        });
        
        if (luckyDirs.length === 0) {
          const tag = document.createElement('span');
          tag.className = 'lucky-tag';
          tag.style.background = 'var(--bg-secondary)';
          tag.style.color = 'var(--text-secondary)';
          tag.textContent = 'ãªã—';
          elements.luckyDirections.appendChild(tag);
        }
      }
    }

    function updateHeading(heading) {
      state.currentHeading = heading;
      
      // Rotate compass dial (opposite direction of heading)
      elements.compassDial.style.transform = `rotate(${-heading}deg)`;
      
      // Update heading display
      elements.headingValue.textContent = `${Math.round(heading)}Â°`;
      
      // Determine cardinal direction
      const directions = ['åŒ—', 'åŒ—æ±', 'æ±', 'å—æ±', 'å—', 'å—è¥¿', 'è¥¿', 'åŒ—è¥¿'];
      const index = Math.round(heading / 45) % 8;
      elements.headingDirection.textContent = directions[index];
    }

    function showDirectionDetail(dir) {
      const status = state.directionStatus[dir.key];
      if (!status) return;
      
      elements.detailCircle.textContent = dir.kanji;
      elements.detailCircle.className = `detail-direction-circle ${status.luck === 'good' ? 'lucky' : ''} ${status.luck === 'bad' ? 'unlucky' : ''}`;
      elements.detailName.textContent = `${dir.kanji}ï¼ˆ${dir.label}ï¼‰`;
      elements.detailAngle.textContent = `${dir.angle}Â°æ–¹å‘`;
      elements.detailStar.textContent = STAR_NAMES[status.star];
      
      if (status.luck === 'good') {
        elements.detailLuck.textContent = 'å‰æ–¹ä½';
        elements.detailLuck.style.color = 'var(--lucky-green)';
      } else if (status.luck === 'bad') {
        elements.detailLuck.textContent = 'å‡¶æ–¹ä½';
        elements.detailLuck.style.color = 'var(--warning-red)';
      } else {
        elements.detailLuck.textContent = 'æ™®é€š';
        elements.detailLuck.style.color = 'var(--text-secondary)';
      }
      
      elements.detailDescription.textContent = status.reason || 
        'ç‰¹ã«å¤§ããªå‰å‡¶ã®å½±éŸ¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚é€šå¸¸ã®è¡Œå‹•ã¯å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚';
      
      elements.detailModal.classList.add('visible');
    }

    function hideDirectionDetail() {
      elements.detailModal.classList.remove('visible');
    }

    // ===== Compass / Sensor Functions =====
    
    function startCompass() {
      if (typeof DeviceOrientationEvent !== 'undefined' && 
          typeof DeviceOrientationEvent.requestPermission === 'function') {
        // iOS 13+ requires permission
        elements.permissionOverlay.classList.add('visible');
      } else {
        // Android or older iOS
        initCompass();
      }
    }

    async function requestPermission() {
      try {
        const permission = await DeviceOrientationEvent.requestPermission();
        elements.permissionOverlay.classList.remove('visible');
        
        if (permission === 'granted') {
          initCompass();
        } else {
          alert('ã‚³ãƒ³ãƒ‘ã‚¹æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ãƒ‡ãƒã‚¤ã‚¹ã®å‘ãã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
        }
      } catch (error) {
        console.error('Permission error:', error);
        elements.permissionOverlay.classList.remove('visible');
        // Fallback to manual mode
        initManualMode();
      }
    }

    function initCompass() {
      state.isCompassActive = true;
      
      window.addEventListener('deviceorientation', (event) => {
        let heading;
        
        if (event.webkitCompassHeading !== undefined) {
          // iOS
          heading = event.webkitCompassHeading;
        } else if (event.alpha !== null) {
          // Android
          heading = 360 - event.alpha;
        } else {
          return;
        }
        
        updateHeading(heading);
      }, true);
    }

    function initManualMode() {
      // For devices without compass, allow manual rotation
      let startAngle = 0;
      let currentAngle = 0;
      
      elements.compassDial.style.transition = 'none';
      
      // Touch events for manual rotation would go here
      console.log('Manual mode initialized - compass sensor not available');
      updateHeading(0);
    }

    // ===== Event Handlers =====
    
    elements.setupForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const birthdateValue = elements.birthdate.value;
      if (!birthdateValue) return;
      
      state.birthdate = new Date(birthdateValue);
      state.honmeisei = calculateHonmeisei(state.birthdate);
      
      const today = new Date();
      state.dailyStar = calculateDailyStar(today);
      
      const directionStars = calculateDirectionStars(state.dailyStar);
      state.directionStatus = calculateLuckStatus(state.honmeisei, directionStars, state.dailyStar);
      
      // Save to localStorage
      localStorage.setItem('kichou_birthdate', birthdateValue);
      
      // Hide setup screen
      elements.setupScreen.classList.add('hidden');
      
      // Render UI
      renderCompassDial();
      updateUI();
      
      // Start compass
      startCompass();
    });

    elements.permissionButton.addEventListener('click', requestPermission);
    
    elements.detailClose.addEventListener('click', hideDirectionDetail);
    elements.detailModal.addEventListener('click', (e) => {
      if (e.target === elements.detailModal) {
        hideDirectionDetail();
      }
    });

    elements.starBadge.addEventListener('click', () => {
      // Reset and show setup screen
      elements.setupScreen.classList.remove('hidden');
    });

    // ===== Initialization =====
    
    function init() {
      // Check for saved birthdate
      const savedBirthdate = localStorage.getItem('kichou_birthdate');
      
      if (savedBirthdate) {
        elements.birthdate.value = savedBirthdate;
        
        // Auto-start if we have saved data
        state.birthdate = new Date(savedBirthdate);
        state.honmeisei = calculateHonmeisei(state.birthdate);
        
        const today = new Date();
        state.dailyStar = calculateDailyStar(today);
        
        const directionStars = calculateDirectionStars(state.dailyStar);
        state.directionStatus = calculateLuckStatus(state.honmeisei, directionStars, state.dailyStar);
        
        elements.setupScreen.classList.add('hidden');
        renderCompassDial();
        updateUI();
        startCompass();
      }
      
      // Set default date to reasonable range
      const maxDate = new Date();
      const minDate = new Date(1920, 0, 1);
      elements.birthdate.max = maxDate.toISOString().split('T')[0];
      elements.birthdate.min = minDate.toISOString().split('T')[0];
    }

    init();
  </script>
</body>
</html>
